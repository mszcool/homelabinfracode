# Custom GRUB configuration for Ubuntu unified autoinstall
# Generated by mszcool's homelab infrastructure code - Unified Version

set default=2  # Point to first actual server configuration (after header and separator)
set timeout=-1  # Wait indefinitely - NEVER auto-boot, always require manual selection
set timeout_style=menu

# Load necessary modules
insmod part_gpt
insmod part_msdos
insmod fat
insmod iso9660
insmod all_video
insmod gfxterm
insmod font

# Set up graphics
if loadfont /boot/grub/fonts/unicode.pf2; then
  set gfxmode=auto
  insmod gfxterm
  terminal_output gfxterm
fi

# Set menu colors
set color_normal=white/black
set color_highlight=black/light-gray

# Main menu header (non-bootable info entry)
menuentry "*** SELECT SERVER TYPE FOR AUTOINSTALL ***" --unrestricted {
    echo "This is an informational header."
    echo "Use arrow keys to select a server configuration below."
    echo "Press any key to return to menu..."
    read
    configfile /boot/grub/grub.cfg
}

menuentry "────────────────── Available Configurations ──────────────────" --unrestricted {
    echo "This is a visual separator showing available configurations:"
{% for host_config in tp_host_configs %}
    echo "  → {{ host_config.name | upper }} ({{ host_config.virtual_disk_config.devices_in_scope | length }} disk{% if host_config.virtual_disk_config.devices_in_scope | length > 1 %}s{% endif %})"
{% endfor %}
    echo ""
    echo "Use arrow keys to select, then press Enter."
    echo "Press any key to return to menu..."
    read
    configfile /boot/grub/grub.cfg
}

{% for host_config in tp_host_configs %}
# Server type: {{ host_config.name }}
menuentry "AUTOINSTALL - {{ host_config.name | upper }} ({{ host_config.virtual_disk_config.devices_in_scope | length }} disk{% if host_config.virtual_disk_config.devices_in_scope | length > 1 %}s{% endif %})" {
    echo "Loading Ubuntu autoinstall for {{ host_config.name }}..."
    echo "WARNING: This will completely wipe all disks on this system!"
    echo "Configuration: {{ host_config.virtual_disk_config.devices_in_scope | map(attribute='device') | join(', ') }}"
    echo "Network: {{ host_config.network_config.physical_network_parent }}"
    linux /casper/vmlinuz boot=casper quiet autoinstall ds=nocloud subiquity.autoinstallpath=/cdrom/configs/{{ host_config.name }}/autoinstall.yaml splash ---
    initrd /casper/initrd
}

{% endfor %}

menuentry "─────────────────── Other Options ────────────────────" --unrestricted {
    echo "Additional options available below:"
    echo "  → Manual Installation (Safe Mode)"
    echo "  → Show Server Information"
    echo "  → System Controls (Reboot/Shutdown)"
    echo ""
    echo "Press any key to return to menu..."
    read
    configfile /boot/grub/grub.cfg
}

# Manual installation option
menuentry "Manual Ubuntu Server Installation (Safe Mode)" {
    echo "Loading Ubuntu installer in manual mode..."
    echo "No automatic installation will occur."
    linux /casper/vmlinuz --- boot=casper quiet splash
    initrd /casper/initrd
}

# Utility options
menuentry "Show Server Type Information" {
    echo "Available server configurations:"
{% for host_config in tp_host_configs %}
    echo "  {{ host_config.name }}:"
    echo "    - Disks: {{ host_config.virtual_disk_config.devices_in_scope | map(attribute='device') | join(', ') }}"
    echo "    - Network: {{ host_config.network_config.physical_network_parent }}"
    echo "    - Root partition: {{ host_config.virtual_disk_config.root_partition.device }} ({{ host_config.virtual_disk_config.root_partition.size_MB }}MB)"
{% endfor %}
    echo ""
    echo "Press any key to return to menu..."
    read
}

# System options
menuentry "Reboot System" {
    echo "Rebooting..."
    reboot
}

menuentry "Shutdown System" {
    echo "Shutting down..."
    halt
}